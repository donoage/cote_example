<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>USER - Cote.js</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
    <link rel="stylesheet" href="//cdn.materialdesignicons.com/2.0.46/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var userService = io.connect('/user');
        var productService = io.connect('/product');
        var purchaseService = io.connect('/purchase');
    </script>
    <style>
        * {
            font-family: 'Lato', sans-serif;
        }

        img.user_img {
            height: 64px;
            border-radius: 50%;
            margin-top: 4%;
        }
    </style>
</head>
<body class="animated fadeIn">
<div id="app" class="container is-widescreen">
    <nav class="navbar" role="navigation" aria-label="dropdown navigation">
        <div class="logo animated jello">
            <img src="https://static1.squarespace.com/static/59975f9a9f7456d2866ec54e/t/599c7d5b893fc0a2909944f6/1521153598582/?format=1500w"
                 alt=""
                 width="80">
        </div>
        <div class="navbar-end">
            <img class="user_img" v-if="user.pic_url" :src="user.pic_url" alt="Image" width="64" height="64">
            <div class="navbar-item">
                <p>
                    <strong>{{ user.name | capitalize}}</strong>
                    <small>@{{ user.name | truncate }}</small>
                    <br>
                    Welcome Back!
                </p>
            </div>
        </div>
    </nav>
    <section class="hero is-primary">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    User UI
                </h1>
                <h2 class="subtitle">
                    Purchase Products
                </h2>
            </div>
        </div>
    </section>
    <br>
    <div class="notification is-danger animated fadeIn" v-if="errors">
        <button class="delete" @click="errors=''"></button>
        {{ errors }}
    </div>
    <h1 class="title">Product Catalog</h1>
    <div class="columns is-multiline is-mobile">
        <div class="column is-one-quarter animated pulse" v-for="product in products">
            <div class="card ">
                <div class="card-content has-text-centered">
                    <strong> {{ product.name }}</strong>
                    <div class="title"></div>
                    <div> Price: {{ product.price }}</div>
                    <div> Stock Left: {{ product.stock }}</div>
                    <div class="title"></div>
                    <div class="button" @click="purchaseProduct(product._id)">Buy</div>
                </div>
            </div>
        </div>
    </div>
    <h1 class="title">Your Products</h1>
    <div class="columns is-multiline is-mobile">
        <div class="column is-one-quarter animated pulse" v-for="purchase in this.user.purchases">
            <div class="card">
                <div class="card-content has-text-centered">
                    <strong> {{ purchase.productName }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.0"></script>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            products: [],
            user: {
                name: '',
                balance: 0,
                pic_url: 0,
                purchases: []
            },
            errors: ''
        },
        mounted() {
            this.listProducts();
            this.createUser();
        },
        filters: {
            capitalize: function (value) {
                if (!value) return '';
                value = value.toString();
                return value.charAt(0).toUpperCase() + value.slice(1)
            },
            truncate: function (value) {
                if (!value) return '';
                return value.toString().replace(/\s/g, '');
            }
        },
        methods: {
            listProducts() {
                productService.emit('list', (data) => {
                    this.products = data.products;
                });
            },
            listUserPurchases() {
                userService.emit('get', {userId: this.user._id}, (data) => {
                    this.user.purchases = data.user.purchases;
                });
            },
            getLatestPurchase(purchase) {
                let productName;

                productService.emit('get', {productId: purchase.productId}, (data) => {
                    productName = data.product.name;
                    this.user.purchases.push({productName: productName});
                });
            },
            createUser() {
                this.$http.get('https://randomuser.me/api').then(res => {
                    let firstName = this.$options.filters.capitalize(res.body.results[0].name.first);
                    let lastName = this.$options.filters.capitalize(res.body.results[0].name.last);
                    let fullName = `${firstName} ${lastName}`;
                    let picUrl = res.body.results[0].picture.thumbnail;

                    userService.emit('create', {balance: 100, name: fullName, pic_url: picUrl}, (data) => {
                        this.user.balance = data.createUser.balance;
                        this.user.name = data.createUser.name;
                        this.user.pic_url = data.createUser.pic_url;
                        this.user._id = data.createUser._id;
                        this.listUserPurchases();
                    });
                }, res => {
                    //TODO:Error
                    console.log(res);
                });
            },
            purchaseProduct(productId) {
                purchaseService.emit('buy', {userId: this.user._id, productId: productId}, (data) => {
                    if (data.errors) {
                        this.errors = data.errors;
                        return;
                    }
                    this.getLatestPurchase(data.createPurchase);
                    this.listProducts();
                });
            }
        }
    });

    productService.on('update', app.listProducts);
</script>
</body>
</html>